sudo: required

language: python

env:
  global:
    - GIT_REGEX="^[^\d]*(\d+)\.(\d+)\.(\d+)-(\d+)-g(.*)"
    - GIT_DESC=$(git describe --tags)
    - REL_MAJOR=$(test $(git describe --tags) =~ ${GIT_REGEX} ; echo "${BASH_REMATCH[1]}")
    - REL_MINOR=$(test $(git describe --tags) =~ "^[^\d]**(\d+)(.*)" ; echo "${BASH_REMATCH[2]}")
  matrix:
    - VER=0.23.1
    - VER=0.24.2
    - VER=0.25.1
    - VER=0.26.1
    - VER=0.27.2
    - VER=0.28.2
    - VER=1.0.0

services:
  - docker

before_install:
  - docker pull emccode/mesos-build-module-dev:${VER}
  - git describe --tags
  - if test "$GIT_DESC =~ $GIT_REGEX"; then export REL_MINOR="${BASH_REMATCH[2]}"; fi
  - export REL_PATCH="${BASH_REMATCH[3]}"
  - export REL_BUILD="${BASH_REMATCH[4]}"
  - export V_SEMVER="${REL_MAJOR}.${REL_MINOR}.${REL_PATCH}"
  - export SEMVER="${V_SEMVER}+${REL_BUILD}"
  - export SO_FILENAME="libmesos_dvdi_isolator-${SEMVER}+mesos-${ISOLATOR_VERSION}.so"
  - env

install:
  - docker run -ti -v $TRAVIS_BUILD_DIR/isolator/:/isolator emccode/mesos-build-module-dev:${VER} /bin/bash -c '/usr/bin/make all && cp /isolator/build/.libs/libmesos_dvdi_isolator-${ISOLATOR_VERSION}.so /isolator/${SO_FILENAME}'

script:
  - shasum $TRAVIS_BUILD_DIR/isolator/${SO_FILENAME}

before_deploy:
  - export V_BRANCH=$(shell git branch | grep '*' | awk '{print $$2}')
  - export V_SHA_LONG=$(shell git show HEAD -s --format=%H)
  - export V_EPOCH=$(shell date +%s)
  - export V_BUILD_DATE=$(shell perl -e 'use POSIX strftime; print strftime("%a, %d %b %Y %H:%M:%S %Z", localtime($(V_EPOCH)))')
  - export V_RELEASE_DATE=$(shell perl -e 'use POSIX strftime; print strftime("%Y-%m-%d", localtime($(V_EPOCH)))')
  - sed -e 's/$${SEMVER}/$(V_SEMVER)/g' \
    -e 's|$${DSCRIP}|$(V_SEMVER).Branch.$(V_BRANCH).Sha.$(V_SHA_LONG)|g' \
    -e 's/$${RELDTE}/$(V_RELEASE_DATE)/g' \
    bintray-unstable.json > bintray-unstable-filtered.json

deploy:
  - provider: bintray
    file: bintray-unstable-filtered.json
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    skip_cleanup: true