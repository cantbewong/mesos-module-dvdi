sudo: required

language: python

env:
  - VER=0.23.1
  - VER=0.24.2
  - VER=0.25.1
  - VER=0.26.1
  - VER=0.27.2
  - VER=0.28.2
  - VER=1.0.0

services:
  - docker

before_install:
  - eval $(./set-travis-env.sh)
  - env
  - docker pull emccode/mesos-build-module-dev:${VER}
  - git describe --tags
  - export SEMVER="${V_SEMVER}+${REL_BUILD}"
  - export SO_FILENAME="libmesos_dvdi_isolator-${SEMVER}+mesos-${VER}.so"
  - env

install:
  - docker run -ti -v $TRAVIS_BUILD_DIR/isolator/:/isolator emccode/mesos-build-module-dev:${VER} /bin/bash -c '/usr/bin/make all && cp /isolator/build/.libs/libmesos_dvdi_isolator-${ISOLATOR_VERSION}.so /isolator/${SO_FILENAME}'

script:
  - shasum $TRAVIS_BUILD_DIR/isolator/${SO_FILENAME}

before_deploy:
  - ls -la $TRAVIS_BUILD_DIR/isolator/
  - sed -e 's/$${SEMVER}/$(V_SEMVER)/g' \
    -e 's|$${DSCRIP}|$(V_SEMVER).Branch.$(V_BRANCH).Sha.$(V_SHA_LONG)|g' \
    -e 's/$${RELDTE}/$(V_RELEASE_DATE)/g' \
    bintray-unstable.json > bintray-unstable-filtered.json
  - cat bintray-unstable-filtered.json

deploy:
  - provider: bintray
    file: bintray-unstable-filtered.json
    user: $BINTRAY_USER
    key: $BINTRAY_KEY
    skip_cleanup: true